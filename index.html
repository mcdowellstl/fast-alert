<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Alert üêº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f7fafc;
            overflow: hidden;
        }

        /* Splash Screen */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #7ec8c4 0%, #5ba59f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splashScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            width: 80%;
            max-width: 400px;
            height: auto;
            animation: fadeInScale 0.8s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .phone-frame {
            max-width: 400px;
            height: 100vh;
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .header-white {
            background: white;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #a0aec0;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f7fafc;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Home Screen Styles */
        .status-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 24px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .status-detail {
            font-size: 16px;
            color: #a0aec0;
        }

        .progress-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 10px 40px rgba(72, 187, 120, 0.3);
            position: relative;
        }

        .progress-inner {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .fasting-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .fasting-saying {
            font-size: 18px;
            font-weight: 600;
            color: #48bb78;
            margin-bottom: 15px;
            text-align: center;
            padding: 0 20px;
        }

        .time-remaining {
            font-size: 56px;
            font-weight: 700;
            color: #48bb78;
            margin-bottom: 5px;
        }

        .time-label {
            font-size: 16px;
            color: #718096;
        }

        .eating-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: #f7fafc;
            border: 3px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }

        .eating-text {
            font-size: 24px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .eating-emoji {
            font-size: 60px;
        }

        .eating-countdown {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin-top: 15px;
        }

        .eating-countdown-label {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }

        .streak-badge {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(246, 173, 85, 0.3);
        }

        .next-fast {
            text-align: center;
            margin-bottom: 30px;
        }

        .next-fast-label {
            color: #718096;
            margin-bottom: 5px;
        }

        .next-fast-time {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .action-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
            transition: transform 0.2s;
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button-stop {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            box-shadow: 0 8px 25px rgba(252, 129, 129, 0.4);
        }

        /* Settings Screen */
        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 12px;
            color: #a0aec0;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
            color: #4a5568;
        }

        .time-input {
            background: #edf2f7;
            padding: 8px 15px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .duration-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .day-selector {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            margin-top: 10px;
        }

        .day-button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #edf2f7;
            color: #718096;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #e2e8f0;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        .test-button {
            background: #edf2f7;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
        }

        /* History Screen */
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stats-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: white;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .toggle-button.active {
            background: #667eea;
            color: white;
        }

        .history-item {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .history-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            margin-right: 15px;
        }

        .icon-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .icon-failed {
            background: #fed7d7;
            color: #742a2a;
        }

        .icon-cheat {
            background: #e2e8f0;
            color: #718096;
        }

        .history-details {
            flex: 1;
        }

        .history-date {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .history-time {
            font-size: 13px;
            color: #a0aec0;
        }

        .history-duration {
            color: #667eea;
            font-weight: 600;
            margin-right: 10px;
        }

        .edit-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-emoji {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .empty-subtext {
            font-size: 14px;
            color: #a0aec0;
        }

        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 320px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .modal-text {
            color: #718096;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button-primary {
            background: #667eea;
            color: white;
        }

        .modal-button-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-button-destructive {
            background: #fc8181;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashScreen">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024'%3E%3Crect width='1024' height='1024' fill='%237ec8c4'/%3E%3Cg transform='translate(512,300)'%3E%3Cellipse cx='0' cy='150' rx='180' ry='200' fill='white'/%3E%3Ccircle cx='-60' cy='80' r='35' fill='%234a5568'/%3E%3Ccircle cx='60' cy='80' r='35' fill='%234a5568'/%3E%3Ccircle cx='-60' cy='85' r='12' fill='white'/%3E%3Ccircle cx='60' cy='85' r='12' fill='white'/%3E%3Cellipse cx='0' cy='120' rx='15' ry='20' fill='%234a5568'/%3E%3Cpath d='M -30 150 Q 0 165 30 150' stroke='%234a5568' stroke-width='6' fill='none'/%3E%3Ccircle cx='-120' cy='40' r='50' fill='%234a5568'/%3E%3Ccircle cx='120' cy='40' r='50' fill='%234a5568'/%3E%3Cpath d='M -150 200 L -100 250 L -120 280 L -100 300 L -80 290 L -60 310' stroke='%23e74c3c' stroke-width='8' fill='none' stroke-linecap='round'/%3E%3Cpath d='M -150 210 Q -130 190 -100 200' fill='%23e74c3c'/%3E%3Cg transform='translate(0,350)'%3E%3Crect x='-150' y='0' width='80' height='15' rx='7' fill='%23d4af37'/%3E%3Crect x='70' y='0' width='80' height='15' rx='7' fill='%23d4af37'/%3E%3Ccircle cx='-110' cy='7.5' r='15' fill='%23d4af37'/%3E%3Ccircle cx='110' cy='7.5' r='15' fill='%23d4af37'/%3E%3Crect x='-8' y='-20' width='16' height='40' fill='%23d4af37'/%3E%3Cpath d='M -80 -10 L -50 25 M 80 -10 L 50 25' stroke='%234a5568' stroke-width='6'/%3E%3Cpath d='M -70 25 Q -30 35 0 30 Q 30 35 70 25' fill='%23f4d03f' stroke='%234a5568' stroke-width='4'/%3E%3C/g%3E%3C/g%3E%3Ctext x='512' y='900' font-size='140' font-weight='800' text-anchor='middle' fill='%234a5568' font-family='Arial'%3EFAST ALERT%3C/text%3E%3C/svg%3E" alt="Fast Alert" class="splash-logo">
    </div>

    <div class="phone-frame">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen">
            <div class="header">
                <h1>Fast Alert üêº</h1>
            </div>
            <div class="content" style="display: flex; flex-direction: column; align-items: center;">
                <div class="status-container">
                    <div class="status-text" id="homeStatusText">Loading...</div>
                    <div class="status-detail" id="homeStatusDetail"></div>
                </div>
                
                <div class="progress-circle" id="progressCircle" style="display: none;">
                    <div class="progress-inner">
                        <div class="fasting-icon">üßò</div>
                        <div class="fasting-saying" id="fastingSaying">You got this!</div>
                        <div class="time-remaining" id="timeRemaining">0:00</div>
                        <div class="time-label" id="timeLabel">hours remaining</div>
                    </div>
                </div>

                <div class="eating-circle" id="eatingCircle" style="display: none;">
                    <div class="eating-text" id="eatingText">Enjoy your meal!</div>
                    <div class="eating-emoji">üç¥</div>
                    <div class="eating-countdown" id="eatingCountdown">0:00</div>
                    <div class="eating-countdown-label">until next fast</div>
                </div>

                <div id="streakBadge" class="streak-badge" style="display: none;">üî• 0 Day Streak</div>

                <div class="next-fast">
                    <div class="next-fast-label" id="nextFastLabel"></div>
                    <div class="next-fast-time" id="nextFastTime"></div>
                </div>

                <button class="action-button" id="manualFastBtn">Start Fast Now</button>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen hidden">
            <div class="header header-white">
                <h1>‚öôÔ∏è Settings</h1>
            </div>
            <div class="content">
                <div class="section">
                    <div class="section-title">FAST TIMING</div>
                    <div class="setting-row">
                        <div class="setting-label">Start Time</div>
                        <input type="time" id="startTime" class="time-input" value="20:00">
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">End Time</div>
                        <input type="time" id="endTime" class="time-input" value="12:00">
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">Duration</div>
                        <div class="duration-badge" id="durationDisplay">16 hours</div>
                    </div>
                    <div style="color: #4a5568; margin: 12px 0; font-weight: 500;">Active Days</div>
                    <div class="day-selector" id="daySelector">
                        <button class="day-button" data-day="0">S</button>
                        <button class="day-button active" data-day="1">M</button>
                        <button class="day-button active" data-day="2">T</button>
                        <button class="day-button active" data-day="3">W</button>
                        <button class="day-button active" data-day="4">T</button>
                        <button class="day-button active" data-day="5">F</button>
                        <button class="day-button" data-day="6">S</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">NOTIFICATIONS</div>
                    <div class="setting-row">
                        <div class="setting-label">Browser Notifications</div>
                        <div class="toggle-switch active" id="notifToggle"></div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-label">Test Notification</div>
                        <button class="test-button" id="testNotifBtn">Send</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ABOUT</div>
                    <div class="setting-row">
                        <div class="setting-label">App Version</div>
                        <div style="color: #a0aec0;">1.0.0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="screen hidden">
            <div class="header header-white">
                <h1>üìä History</h1>
            </div>
            <div class="content">
                <div class="stats-card">
                    <div class="stats-title">Your Progress</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="successRate">0%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="currentStreak">üî• 0</div>
                            <div class="stat-label">Current Streak</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="longestStreak">0</div>
                            <div class="stat-label">Longest Streak</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalFasts">0h</div>
                            <div class="stat-label">Total Time Fasting</div>
                        </div>
                    </div>
                </div>

                <div class="view-toggle">
                    <button class="toggle-button active">List View</button>
                    <button class="toggle-button">Calendar</button>
                </div>

                <div id="historyList"></div>

                <div id="emptyState" class="empty-state">
                    <div class="empty-emoji">üìÖ</div>
                    <div class="empty-text">No fasting history yet</div>
                    <div class="empty-subtext">Complete your first fast to see it here!</div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-screen="home">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" data-screen="settings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
            <div class="nav-item" data-screen="history">
                <div class="nav-icon">üìÖ</div>
                <div class="nav-label">History</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-text" id="modalText"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        // State
        const state = {
            settings: {
                startTime: '20:00',
                endTime: '12:00',
                activeDays: [1, 2, 3, 4, 5],
                notificationsEnabled: true
            },
            history: [],
            manualFast: null,
            currentScreen: 'home'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Hide splash screen
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                splash.classList.add('fade-out');
                setTimeout(() => splash.style.display = 'none', 500);
            }, 2000);

            // Load data
            loadData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update UI
            updateHomeScreen();
            updateSettings();
            
            // Start update interval
            setInterval(updateHomeScreen, 60000);
        });

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    showScreen(item.dataset.screen);
                });
            });

            // Manual fast button
            document.getElementById('manualFastBtn').addEventListener('click', toggleManualFast);

            // Settings inputs
            document.getElementById('startTime').addEventListener('change', updateSettings);
            document.getElementById('endTime').addEventListener('change', updateSettings);

            // Day selector
            document.querySelectorAll('.day-button').forEach(btn => {
                btn.addEventListener('click', () => toggleDay(parseInt(btn.dataset.day)));
            });

            // Notification toggle
            document.getElementById('notifToggle').addEventListener('click', toggleNotifications);
            document.getElementById('testNotifBtn').addEventListener('click', sendTestNotification);

            // Modal click outside to close
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') hideModal();
            });
        }

        // Data persistence
        function loadData() {
            const saved = localStorage.getItem('fastAlert');
            if (saved) {
                const data = JSON.parse(saved);
                state.settings = data.settings || state.settings;
                state.history = data.history || [];
                state.manualFast = data.manualFast || null;
            }
        }

        function saveData() {
            localStorage.setItem('fastAlert', JSON.stringify({
                settings: state.settings,
                history: state.history,
                manualFast: state.manualFast
            }));
        }

        // Navigation
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(screen + 'Screen').classList.remove('hidden');
            document.querySelector(`[data-screen="${screen}"]`).classList.add('active');
            
            state.currentScreen = screen;
            
            if (screen === 'history') {
                renderHistory();
                updateStats();
            }
        }

        // Home screen
        function updateHomeScreen() {
            const now = new Date();
            const currentDay = now.getDay();
            const hasActiveScheduleToday = state.settings.activeDays.includes(currentDay);
            const isScheduledFast = isFastingNow();
            const isInManualFast = state.manualFast !== null;
            
            // Auto-end manual fast if scheduled fast starts
            if (isInManualFast && isScheduledFast) {
                endManualFast(true);
                return;
            }
            
            const isFasting = isInManualFast || isScheduledFast;
            const btn = document.getElementById('manualFastBtn');
            
            if (!hasActiveScheduleToday && !isInManualFast) {
                document.getElementById('homeStatusText').textContent = 'üéâ No Scheduled Fasts Today';
                document.getElementById('homeStatusDetail').textContent = 'Enjoy your day!';
                document.getElementById('progressCircle').style.display = 'none';
                document.getElementById('eatingCircle').style.display = 'none';
                btn.textContent = 'Start Fast Now';
                btn.className = 'action-button';
            } else if (isFasting) {
                if (isInManualFast) {
                    document.getElementById('homeStatusText').textContent = '‚è≥ Manual Fast Mode';
                    document.getElementById('homeStatusDetail').textContent = '';
                } else {
                    document.getElementById('homeStatusText').textContent = '‚è∞ Scheduled Fast Mode';
                    document.getElementById('homeStatusDetail').textContent = `Started at ${formatTime(state.settings.startTime)}`;
                }
                
                document.getElementById('progressCircle').style.display = 'flex';
                document.getElementById('eatingCircle').style.display = 'none';
                updateTimeRemaining();
                
                if (isInManualFast) {
                    document.getElementById('nextFastLabel').textContent = 'Fasting since';
                    const start = new Date(state.manualFast.startTimestamp);
                    document.getElementById('nextFastTime').textContent = start.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
                } else {
                    document.getElementById('nextFastLabel').textContent = 'Fast ends at';
                    document.getElementById('nextFastTime').textContent = formatTime(state.settings.endTime);
                }
                
                btn.textContent = 'End Fast Now';
                btn.className = 'action-button action-button-stop';
            } else {
                document.getElementById('homeStatusText').textContent = 'üòã Eating Window';
                document.getElementById('homeStatusDetail').textContent = 'Enjoy your meal!';
                document.getElementById('progressCircle').style.display = 'none';
                document.getElementById('eatingCircle').style.display = 'flex';
                updateEatingCountdown();
                
                document.getElementById('nextFastLabel').textContent = 'Next fast starts at';
                document.getElementById('nextFastTime').textContent = formatTime(state.settings.startTime);
                
                btn.textContent = 'Start Fast Now';
                btn.className = 'action-button';
            }
            
            updateStreakBadge();
        }

        function isFastingNow() {
            const now = new Date();
            const currentDay = now.getDay();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            if (!state.settings.activeDays.includes(currentDay)) return false;
            
            // Check if user ended fast early today
            const todayRecord = state.history.find(r => 
                r.date === new Date().toISOString().split('T')[0] && 
                r.endedEarly
            );
            if (todayRecord && todayRecord.earlyEndTime) {
                // If they ended the fast early, they're not fasting anymore today
                return false;
            }
            
            const [startH, startM] = state.settings.startTime.split(':').map(Number);
            const [endH, endM] = state.settings.endTime.split(':').map(Number);
            
            const startMin = startH * 60 + startM;
            const endMin = endH * 60 + endM;
            
            if (startMin > endMin) {
                return currentMinutes >= startMin || currentMinutes < endMin;
            }
            
            return currentMinutes >= startMin && currentMinutes < endMin;
        }

        function updateTimeRemaining() {
            const now = new Date();
            
            if (state.manualFast) {
                const diff = now - state.manualFast.startTimestamp;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('timeRemaining').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
                document.getElementById('timeLabel').textContent = 'hours elapsed';
            } else {
                const [endH, endM] = state.settings.endTime.split(':').map(Number);
                let target = new Date();
                target.setHours(endH, endM, 0, 0);
                if (target <= now) target.setDate(target.getDate() + 1);
                
                const diff = target - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('timeRemaining').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
                document.getElementById('timeLabel').textContent = 'hours remaining';
            }
            
            // Random fasting saying
            const sayings = ["You got this!", "Stay strong!", "On track!", "The good fight!", "Keep going!", "Almost there!", "Crushing it!", "Mind over matter!", "Stay focused!", "Discipline!", "You're amazing!", "Don't give up!", "Be strong!", "Willpower!", "Believe!", "Push through!", "Stay committed!", "Inner strength!", "You're doing great!", "Persevere!"];
            if (!window.currentFastingSaying) {
                window.currentFastingSaying = sayings[Math.floor(Math.random() * sayings.length)];
            }
            document.getElementById('fastingSaying').textContent = window.currentFastingSaying;
        }

        function updateEatingCountdown() {
            const now = new Date();
            const [startH, startM] = state.settings.startTime.split(':').map(Number);
            let target = new Date();
            target.setHours(startH, startM, 0, 0);
            if (target <= now) target.setDate(target.getDate() + 1);
            
            const diff = target - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('eatingCountdown').textContent = `${hours}:${minutes.toString().padStart(2, '0')}`;
            
            // Random eating saying
            const sayings = ["Yum Yum!", "Eat Up!", "Bon App√©tit!", "Chow Down!", "Dig In!", "Enjoy!", "Nom Nom!", "Fuel Up!", "Feast Time!", "Savor It!", "Treat Yourself!", "Refuel!", "Time to Eat!", "Indulge!", "Nourish!", "Tasty Time!", "Chow Time!", "Feed Well!", "Satisfy!", "Delicious!"];
            if (!window.currentEatingSaying) {
                window.currentEatingSaying = sayings[Math.floor(Math.random() * sayings.length)];
            }
            document.getElementById('eatingText').textContent = window.currentEatingSaying;
        }

        function updateStreakBadge() {
            const stats = calculateStats();
            const badge = document.getElementById('streakBadge');
            if (stats.currentStreak > 0) {
                badge.textContent = `üî• ${stats.currentStreak} Day Streak`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Manual fast
        function toggleManualFast() {
            if (state.manualFast) {
                endManualFast();
            } else if (isFastingNow()) {
                endScheduledFastEarly();
            } else {
                startManualFast();
            }
        }

        function startManualFast() {
            state.manualFast = {
                startTimestamp: Date.now()
            };
            window.currentFastingSaying = null;
            saveData();
            updateHomeScreen();
        }

        function endManualFast(autoComplete = false) {
            if (!state.manualFast) return;
            
            const now = Date.now();
            const duration = (now - state.manualFast.startTimestamp) / (1000 * 60 * 60);
            
            const record = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                startTime: new Date(state.manualFast.startTimestamp).toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                endTime: new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                durationHours: duration,
                completed: null,
                isManual: true
            };
            
            state.history.unshift(record);
            state.manualFast = null;
            window.currentFastingSaying = null;
            saveData();
            updateHomeScreen();
            
            if (!autoComplete) {
                showModal('Manual Fast Ended', `Great job! You fasted for ${Math.floor(duration)} hours and ${Math.round((duration % 1) * 60)} minutes.`, [
                    {text: 'OK', primary: true, action: hideModal}
                ]);
            }
        }

        function endScheduledFastEarly() {
            const now = Date.now();
            const [startH, startM] = state.settings.startTime.split(':').map(Number);
            let start = new Date();
            start.setHours(startH, startM, 0, 0);
            if (start > now) start.setDate(start.getDate() - 1);
            
            const duration = (now - start.getTime()) / (1000 * 60 * 60);
            
            const record = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                startTime: state.settings.startTime,
                endTime: new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                durationHours: duration,
                completed: false,
                endedEarly: true,
                earlyEndTime: Date.now()
            };
            
            state.history.unshift(record);
            window.currentFastingSaying = null;
            saveData();
            updateHomeScreen();
            
            showModal('Scheduled Fast Ended Early', `Fast marked as incomplete. You fasted for ${Math.floor(duration)} hours and ${Math.round((duration % 1) * 60)} minutes.`, [
                {text: 'OK', primary: true, action: hideModal}
            ]);
        }

        // Settings
        function updateSettings() {
            state.settings.startTime = document.getElementById('startTime').value;
            state.settings.endTime = document.getElementById('endTime').value;
            
            const duration = calculateDuration(state.settings.startTime, state.settings.endTime);
            document.getElementById('durationDisplay').textContent = `${Math.round(duration)} hours`;
            
            saveData();
            updateHomeScreen();
        }

        function toggleDay(dayIndex) {
            if (state.settings.activeDays.includes(dayIndex)) {
                state.settings.activeDays = state.settings.activeDays.filter(d => d !== dayIndex);
            } else {
                state.settings.activeDays.push(dayIndex);
                state.settings.activeDays.sort();
            }
            
            document.querySelectorAll('.day-button').forEach((btn, i) => {
                btn.classList.toggle('active', state.settings.activeDays.includes(i));
            });
            
            saveData();
            updateHomeScreen();
        }

        function toggleNotifications() {
            state.settings.notificationsEnabled = !state.settings.notificationsEnabled;
            document.getElementById('notifToggle').classList.toggle('active', state.settings.notificationsEnabled);
            saveData();
        }

        function sendTestNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üêº Test Notification', {
                    body: 'Your Fast Alert notifications are working perfectly!'
                });
            } else if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('üêº Test Notification', {
                            body: 'Your Fast Alert notifications are working perfectly!'
                        });
                    }
                });
            } else {
                alert('Notifications not supported');
            }
        }

        // History
        function renderHistory() {
            const list = document.getElementById('historyList');
            const empty = document.getElementById('emptyState');
            
            if (state.history.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = state.history.map(record => {
                let iconClass, iconText;
                if (record.isManual) {
                    iconClass = 'icon-cheat';
                    iconText = '‚è±Ô∏è';
                } else if (record.completed === true) {
                    iconClass = 'icon-success';
                    iconText = '‚úì';
                } else if (record.completed === false) {
                    iconClass = 'icon-failed';
                    iconText = '‚úó';
                } else {
                    iconClass = 'icon-cheat';
                    iconText = '?';
                }
                
                const editBtn = record.isManual ? '<div style="width: 34px;"></div>' : `<button class="edit-button" onclick="editRecord('${record.id}')">‚úèÔ∏è</button>`;
                
                return `
                    <div class="history-item">
                        <div class="history-icon ${iconClass}">${iconText}</div>
                        <div class="history-details">
                            <div class="history-date">${formatDate(record.date)}${record.isManual ? ' (Manual)' : ''}</div>
                            <div class="history-time">${formatTime(record.startTime)} - ${formatTime(record.endTime)}</div>
                        </div>
                        <div class="history-duration">${Math.round(record.durationHours)}h</div>
                        ${editBtn}
                    </div>
                `;
            }).join('');
        }

        function editRecord(recordId) {
            showModal('Edit Fast Record', 'Update the status of this fast:', [
                {text: 'Cancel', secondary: true, action: hideModal},
                {text: 'Failed ‚úó', destructive: true, action: () => updateRecord(recordId, false)},
                {text: 'Success ‚úì', primary: true, action: () => updateRecord(recordId, true)}
            ]);
        }

        function updateRecord(recordId, completed) {
            const record = state.history.find(r => r.id === recordId);
            if (record) {
                record.completed = completed;
                saveData();
                renderHistory();
                updateStats();
                updateHomeScreen();
            }
            hideModal();
        }

        function calculateStats() {
            const validFasts = state.history.filter(r => !r.isManual);
            const successfulFasts = validFasts.filter(r => r.completed === true);
            const allFasts = state.history;
            const totalTime = allFasts.reduce((sum, r) => sum + (r.durationHours || 0), 0);
            
            let currentStreak = 0;
            for (const r of state.history) {
                if (r.isManual) continue;
                if (r.completed === true) currentStreak++;
                else break;
            }
            
            let longestStreak = 0, tempStreak = 0;
            for (const r of state.history) {
                if (r.isManual) continue;
                if (r.completed === true) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }
            
            const successRate = validFasts.length > 0 ? Math.round((successfulFasts.length / validFasts.length) * 100) : 0;
            
            return {totalTime: Math.round(totalTime), successRate, currentStreak, longestStreak};
        }

        function updateStats() {
            const stats = calculateStats();
            document.getElementById('successRate').textContent = stats.successRate + '%';
            document.getElementById('currentStreak').textContent = 'üî• ' + stats.currentStreak;
            document.getElementById('longestStreak').textContent = stats.longestStreak;
            document.getElementById('totalFasts').textContent = stats.totalTime + 'h';
        }

        // Modal
        function showModal(title, text, buttons) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('modalButtons').innerHTML = buttons.map(btn => {
                let className = 'modal-button';
                if (btn.primary) className += ' modal-button-primary';
                if (btn.secondary) className += ' modal-button-secondary';
                if (btn.destructive) className += ' modal-button-destructive';
                return `<button class="${className}" onclick="(${btn.action.toString()})()">${btn.text}</button>`;
            }).join('');
            
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function hideModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        // Utilities
        function calculateDuration(startTime, endTime) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            let duration = (endH * 60 + endM) - (startH * 60 + startM);
            if (duration < 0) duration += 24 * 60;
            return duration / 60;
        }

        function formatTime(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }
    </script>
</body>
</html>